#include "Relics\Gadget\Discount\ExploitableCoupon.h"
#include "Relics\Utility\RelicInternalHelper.h"
#include "Relics\Utility\RelicFuncInputTypes.h"
#include "Relics\Utility\RelicParticleHelper.h"
#include "Registry.h"
#include "Components.h"

EntityID EXPLOITABLE_COUPON::_OWNER;

#define EXPLOITABLE_COUPON_COST_MULT (.7f)

static bool _Exploitable_Coupon_Active = false;

const char* EXPLOITABLE_COUPON::Description()
{
	static char temp[RELIC_DATA_DESC_SIZE];
	sprintf_s(temp, "Reduces the cost of all relics and services by %ld%% until you leave the current shop",
		100 - PERCENT(EXPLOITABLE_COUPON_COST_MULT));
#pragma warning(suppress : 4172)
	return temp;
}

void EXPLOITABLE_COUPON::Initialize(void* input)
{
	// Set owner
	EXPLOITABLE_COUPON::_OWNER = *((EntityID*)input);

	// Make sure the relic function map exists
	_validateRelicFunctions();

	// Set the relic to active
	_Exploitable_Coupon_Active = true;

	// Add disable function to level swap list
	(*_RelicFunctions)[FUNC_ON_LEVEL_SWITCH].push_back(EXPLOITABLE_COUPON::Disable);

	// Add it to the list of on price calc functions
	(*_RelicFunctions)[FUNC_ON_PRICE_CALC].push_back(EXPLOITABLE_COUPON::DiscountAll);
}

void EXPLOITABLE_COUPON::Disable(void* data)
{
	_Exploitable_Coupon_Active = false;
}

void EXPLOITABLE_COUPON::DiscountAll(void* data)
{
	// Get the input
	RelicInput::OnPriceCalculation* input = (RelicInput::OnPriceCalculation*)data;

	if (_Exploitable_Coupon_Active)
		input->everythingCostMult *= EXPLOITABLE_COUPON_COST_MULT;
}
